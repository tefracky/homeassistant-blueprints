blueprint:
  source_url: "https://raw.githubusercontent.com/tefracky/homeassistant-blueprints/blueprints/automations/notifications-and-announcements.yaml"
  name: Benachrichtigungen & Durchsagen (Android + Persistent)
  description: >
    # üì¢ Benachrichtigungen & Durchsagen
    
    **Version: 1.5**
    
    
    Lege deinen Ausl√∂ser fest und verbreite die Nachricht üí¨üîâ
    
    
    **Wenn dir meine Blueprints gefallen und du deine Unterst√ºtzung zeigen oder einfach Danke sagen m√∂chtest,** [Hier klicken](https://www.paypal.com/donate/?hosted_button_id=WAZS3QSDTPGA8) üôÇ
    
    <details>
    <summary><b>Der Automatisierungsprozess:</b> - Hier klicken, um mehr anzuzeigen</summary>
    
    
      - **Trigger Optionen:**
    
        - Gib den Zustandswechsel einer oder mehrerer Entit√§ten ein, der die Automatisierung ausl√∂sen soll, und w√§hle diesen aus einer Dropdown-Liste aus. Falls der gew√ºnschte Zustand nicht in der Dropdown-Liste verf√ºgbar ist, kannst du auch einen eigenen benutzerdefinierten Zustand angeben.
        - Optionen f√ºr Zustands√§nderungen: Die verf√ºgbaren Zustands√§nderungen umfassen:
            - **Allgemeine Zust√§nde:** Button oder beliebiger Zustand, AN, AUS, Nicht verf√ºgbar oder Unbekannt
            - **Standortbezogene Zust√§nde:** Zuhause oder Nicht zu Hause
            - **Numerische Zust√§nde:** Numerischer Zustand - √úber, Numerischer Zustand - Unter oder Numerischer Zustand - √úber & Unter
    
      - **Benachrichtigungsoptionen:**
    
        - Entscheide, ob Nachrichten an ein oder mehrere Ger√§te gesendet werden sollen. Kompatibel mit Apple iOS und Android-Ger√§ten.
        - W√§hle, ob deine Benachrichtigungen direkt in der Home Assistant-Benutzeroberfl√§che (UI) angezeigt werden sollen.
        - Entscheide dich dazu, eine Text-to-Speech-Durchsage an die ausgew√§hlten Medienplayer zu senden.
        - W√§hle, ob eine benutzerdefinierte Aktion ausgef√ºhrt werden soll.
    
      - **Zeitbasierte Automatisierung:**
    
        - Lege genaue Start- und Endzeiten sowie die Wochentage fest, an denen die Automatisierung ausgef√ºhrt werden darf.
    
      - **Benutzerdefinierte Bedingungen:**
    
        - Gib beliebige benutzerdefinierte Bedingungen ein, um den Automatisierungsprozess weiter zu individualisieren.
    
    </details>
    
    
    Brauchst du Hilfe? Sieh dir unsere FAQ an: [Hier klicken](https://community.home-assistant.io/t/notifications-announcements/728100/2?u=blacky)
    
    Lass uns wissen, was du von diesem Blueprint h√§ltst und unterst√ºtze die Community inklusive Updates: [Hier klicken](https://community.home-assistant.io/t/notifications-announcements/728100?u=blacky)
    
    
    Erforderlich = *
  domain: automation
  input:
    trigger_settings:
      name: "Trigger *"
      icon: mdi:cog-outline
      collapsed: true
      input:
        trigger_state:
          name: Trigger - Zustand *
          description: >
            Bitte w√§hle den Zustand, der den Trigger ausl√∂sen soll.
            Du kannst aus den zehn verf√ºgbaren Optionen im Dropdown-Men√º w√§hlen.
            Falls deine Option nicht im Dropdown-Men√º vorhanden ist, gib einfach den gew√ºnschten Zustand ein und klicke auf die Speichern-Schaltfl√§che.
            
            1 - Button Oder Beliebiger Zustand
            
            2 - AN
            
            3 - AUS
            
            4 - Nicht verf√ºgbar
            
            5 - Unbekannt
            
            6 - Zuhause
            
            7 - Nicht zu Hause
            
            8 - Numerischer Zustand - √úber
            
            9 - Numerischer Zustand - Unter
            
            10 - Numerischer Zustand - √úber & Unter
            
            Ein Nummerierungssystem wurde implementiert, um die Navigation innerhalb der Dropdown-Auswahl zu erleichtern.
            Jede Nummer entspricht einer spezifischen Konfiguration, die dem Nutzer hilft, die verwendeten Einstellungen zu identifizieren und anzupassen.
            Beispielsweise erfordert die Auswahl "8 - Numerischer Zustand - √úber" die Einstellungen, die mit "Verwendet in den Optionen 8, 9 oder 10" markiert sind, da Nummer 8 in diesen Optionen enthalten ist.
          default: button_any_state
          selector:
            select:
              custom_value: true
              mode: dropdown
              options:
                - label: "1 - Button Oder Beliebiger Zustand"
                  value: "button_any_state"
                - label: "2 - AN"
                  value: "on"
                - label: "3 - AUS"
                  value: "off"
                - label: "4 - Nicht verf√ºgbar"
                  value: "unavailable"
                - label: "5 - Unbekannt"
                  value: "unknown"
                - label: "6 - Zuhause"
                  value: "home"
                - label: "7 - Nicht zu Hause"
                  value: "not_home"
                - label: "8 - Numerischer Zustand - √úber"
                  value: "numeric_state_above"
                - label: "9 - Numerischer Zustand - Unter"
                  value: "numeric_state_below"
                - label: "10 - Numerischer Zustand - √úber & Unter"
                  value: "numeric_state_above_below"
        trigger_state_entity:
          name: Zustands-Entit√§ten
          description: >
            **Verwendet in den Optionen 1, 2, 3, 4, 5, 6 oder 7.**
            Gib die Entit√§ten an, die den Zustandwechsel ausl√∂sen.
          default: []
          selector:
            entity:
              multiple: true
        trigger_numeric_entity:
          name: Numerische Zustands-Entit√§ten
          description: >
            **Verwendet in den Optionen 8, 9 oder 10.**
            Gib die Entit√§ten an, die den numerischen Zustandswechsel √ºberwachen.
          default: []
          selector:
            entity:
              multiple: true
        above_state:
          name: Numerischer Zustand - √úber Option
          description: >
            **Verwendet in den Optionen 8 oder 10.**
            Setze den Schwellenwert, bei dessen √úberschreitung der numerische Zustand den festgelegten Wert √ºberschreitet.
          default: 0
          selector:
            number:
              min: -20
              max: 100
              step: 1
              unit_of_measurement: Wert
        below_state:
          name: Numerischer Zustand - Unter Option
          description: >
            **Verwendet in den Optionen 9 oder 10.**
            Setze den Schwellenwert, bei dessen Unterschreitung der numerische Zustand den festgelegten Wert unterschreitet.
          default: 0
          selector:
            number:
              min: -20
              max: 100
              step: 1
              unit_of_measurement: Wert
        time_delay_state:
          name: Zeitverz√∂gerung
          description: >
            **Verwendet in allen Optionen.**
            Bestimme die Dauer, die der Triggerzustand kontinuierlich bestehen muss, bevor die Automatisierung ausgef√ºhrt wird.
          default:
            hours: 0
            minutes: 0
            seconds: 0
          selector:
            duration:
    device_notify_settings:
      name: "Benachrichtigungen (Mobil und Persistent)"
      icon: mdi:devices
      collapsed: true
      input:
        include_notify:
          name: Mobile App Benachrichtigungsoption
          description: >
            Diese Option ist immer aktiviert, um Benachrichtigungen an die ausgew√§hlten Ger√§te zu senden.
          default: enable_mobile_app_notify
          selector:
            select:
              options:
                - label: Mobile App Benachrichtigungsoption aktivieren
                  value: "enable_mobile_app_notify"
                - label: Mobile App Benachrichtigungsoption deaktivieren
                  value: "disable_mobile_app_notify"
        notify_device:
          name: Ger√§te oder Gruppe zur Benachrichtigung
          description: >
            W√§hle den Benachrichtigungsdienst (z.‚ÄØB. notify.all_devices oder eine andere Gruppe) aus, an den die Nachricht gesendet werden soll.
          default: "notify.all_devices"
          selector:
            service:
        notify_title:
          name: Benachrichtigungstitel
          description: >
            Gib den Titel der Benachrichtigung ein, der sowohl f√ºr die Android-Benachrichtigung als auch f√ºr die feste (persistente) Benachrichtigung in der UI verwendet wird.
          default: "üì¢ Gebe hier den Benachrichtigungstitel ein"
          selector: 
            text:
        notify_message:
          name: Benachrichtigungsnachricht
          description: >
            Gib die Nachricht der Benachrichtigung ein, die sowohl f√ºr die Android-Benachrichtigung als auch f√ºr die feste Benachrichtigung in der UI verwendet wird.
          default: "Gebe hier die Benachrichtigungsnachricht ein üôÇ"
          selector:
            text:
        # iOS-spezifische Optionen auskommentiert:
        # notify_interruption_level:
        #   name: Interruption Level - iOS Only
        #   description: >
        #     Auf Ger√§ten mit iOS 15 und h√∂her kannst du das Interruption Level deiner Benachrichtigungen konfigurieren,
        #     um sicherzustellen, dass sie entsprechend deiner Pr√§ferenzen zugestellt werden.
        #   default: active
        #   selector:
        #     select:
        #       mode: dropdown
        #       options:
        #         - label: Standard
        #           value: "active"
        #         - label: Kritische Benachrichtigungen
        #           value: "critical"
        #         - label: Zeitkritische Benachrichtigungen
        #           value: "time-sensitive"
        #         - label: Stille Benachrichtigungen ohne Bildschirmaktivierung
        #           value: "passive"
        # notify_sound:
        #   name: Benachrichtigungston - iOS Only
        #   description: >
        #     Die Home Assistant App f√ºr iOS bietet integrierte Benachrichtigungst√∂ne. Hier kannst du auch benutzerdefinierte T√∂ne angeben.
        #   default: []
        #   selector:
        #     text:
        notify_data:
          name: "Android-spezifische Optionen (Optional)"
          description: >
            **Optionen f√ºr Android (Optional):**
            - **High Priority**: Benachrichtigungen werden sofort zugestellt, um sicherzustellen, dass wichtige Meldungen umgehend empfangen werden.
            - **Sticky Notification**: Wichtige Meldungen bleiben in der Benachrichtigungsleiste, bis sie aktiv entfernt werden.
            - **Notification Channel**: Erm√∂glicht es, verschiedene Benachrichtigungseinstellungen (einschlie√ülich T√∂ne, Vibrationen und andere ger√§tespezifische Funktionen) zu organisieren. Diese Option wird immer genutzt und erfordert die Eingabe eines Channel-Namens.
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: Hochpriorit√§t
                  value: "high_priority"
                - label: Sticky Notification
                  value: "sticky"
                - label: Notification Channel
                  value: "channel"
        notify_channel:
          name: Notification Channel - Android & Persistent
          description: >
            Gib den Namen des Notification Channels ein. Dieser Channel wird auch als Tag f√ºr die persistente Benachrichtigung verwendet.
            Diese Eingabe ist stets erforderlich. Falls du noch keinen Channel hast, wird dieser beim ersten Senden der Benachrichtigung erstellt und kann anschlie√üend konfiguriert werden.
            Empfohlenes Icon: mdi:radio
          default: "default_channel"
          selector:
            text:
        # Use The Notify Zone Option auskommentiert:
        # include_notify_zone:
        #   name: Benachrichtigungszonenoption (Optional)
        #   description: >
        #     Home Assistant kann den Standort deiner Ger√§te verfolgen und Benachrichtigungen nur an Ger√§te in einem bestimmten Bereich senden.
        #   default: zone_disabled
        #   selector:
        #     select:
        #       options:
        #         - label: Zone-Option aktivieren
        #           value: "zone_enabled"
        #         - label: Zone-Option deaktivieren
        #           value: "zone_disabled"
        # notify_zone:
        #   name: Benachrichtigungszone
        #   description: >
        #     W√§hle die Zone aus, an die die Benachrichtigung gesendet werden soll.
        #   default: []
        #   selector:
        #     entity:
        #       filter:
        #         domain: zone
    # Feste (persistente) Benachrichtigung (UI) auskommentiert, da Titel und Nachricht mit den Android-Benachrichtigungen synchronisiert werden:
    # persistent_notify_settings:
    #   name: "Benachrichtigungen (UI)"
    #   icon: mdi:bell-outline
    #   collapsed: true
    #   input:
    #     include_persistent_notification:
    #       name: UI-Benachrichtigungsoption (Optional)
    #       description: >
    #         Aktiviert die Anzeige von Benachrichtigungen direkt in der Home Assistant Benutzeroberfl√§che.
    #       default: enable_persistent_notification
    #       selector:
    #         select:
    #           options:
    #             - label: UI-Benachrichtigungen aktivieren
    #               value: "enable_persistent_notification"
    #             - label: UI-Benachrichtigungen deaktivieren
    #               value: "disabled_persistent_notification"
    #     persistent_title:
    #       name: Titel
    #       description: >
    #         Gib den Titel der UI-Benachrichtigung ein.
    #       default: "üì¢ Gebe hier den UI-Titel ein"
    #       selector:
    #         text:
    #     persistent_message:
    #       name: Nachricht
    #       description: >
    #         Gib die Nachricht der UI-Benachrichtigung ein.
    #       default: "Gebe hier die UI-Nachricht ein üôÇ"
    #       selector:
    #         text:
    # Text-to-Speech Optionen auskommentiert:
    # tts_notify_settings:
    #   name: "Text-to-Speech Durchsage"
    #   icon: mdi:bullhorn-outline
    #   collapsed: true
    #   input:
    #     include_tts_announcement:
    #       name: Text-to-Speech Durchsageoption (Optional)
    #       description: >
    #         Aktiviert die Text-to-Speech Durchsage an ausgew√§hlten Medienplayern.
    #       default: disable_tts_announcement
    #       selector:
    #         select:
    #           options:
    #             - label: Text-to-Speech Durchsagen aktivieren
    #               value: "enable_tts_announcement"
    #             - label: Text-to-Speech Durchsagen deaktivieren
    #               value: "disable_tts_announcement"
    #     text_to_speech_engine:
    #       name: Text-to-Speech Dienstanbieter
    #       description: >
    #         W√§hle den Text-to-Speech Dienstanbieter aus.
    #       default: []
    #       selector:
    #         entity:
    #           filter:
    #             domain: tts
    #     media_player:
    #       name: Medienplayer
    #       description: >
    #         W√§hle die Medienplayer aus, die die Text-to-Speech Durchsage abspielen sollen.
    #       default: []
    #       selector:
    #         entity:
    #           filter:
    #             domain: media_player
    #           multiple: true
    #     notify_tts_message:
    #       name: Durchsagenachricht
    #       description: >
    #         Gib die Nachricht f√ºr die Text-to-Speech Durchsage ein.
    #       default: "Gebe hier die TTS-Nachricht ein"
    #       selector:
    #         text:
    #           multiline: true
    # Zeitbezogene Optionen auskommentiert:
    # time_settings:
    #   name: "Zeit"
    #   icon: mdi:clock-outline
    #   collapsed: true
    #   input:
    #     include_time:
    #       name: Zeitoptionen (Optional)
    #       description: >
    #         Nutze die Optionen Startzeit, Endzeit und Wochentage, um die Automatisierung auf bestimmte Zeiten zu beschr√§nken.
    #       default: time_disabled
    #       selector:
    #         select:
    #           options:
    #             - label: Zeitoptionen aktivieren
    #               value: "time_enabled"
    #             - label: Zeitoptionen deaktivieren
    #               value: "time_disabled"
    #     after_time:
    #       name: Startzeit
    #       description: >
    #         Lege die Startzeit fest.
    #       default: 00:00:00
    #       selector:
    #         time:
    #     before_time:
    #       name: Endzeit
    #       description: >
    #         Lege die Endzeit fest.
    #       default: 00:00:00
    #       selector:
    #         time:
    #     weekday_options:
    #       name: Wochentage
    #       description: >
    #         W√§hle die Wochentage aus, an denen die Automatisierung aktiv sein soll.
    #       default:
    #         - mon
    #         - tue
    #         - wed
    #         - thu
    #         - fri
    #         - sat
    #         - sun
    #       selector:
    #         select:
    #           multiple: true
    #           mode: list
    #           options:
    #             - label: Montag
    #               value: "mon"
    #             - label: Dienstag
    #               value: "tue"
    #             - label: Mittwoch
    #               value: "wed"
    #             - label: Donnerstag
    #               value: "thu"
    #             - label: Freitag
    #               value: "fri"
    #             - label: Samstag
    #               value: "sat"
    #             - label: Sonntag
    #               value: "sun"
    custom_actions_settings:
      name: "Benutzerdefinierte Aktionen"
      icon: mdi:code-tags
      collapsed: true
      input:
        include_custom_actions:
          name: Benutzerdefinierte Aktionsoption (Optional)
          description: >
            Passe deine Automatisierung mit beliebigen Aktionen an.
            Zum Beispiel kannst du Durchsagen auf speziellen Lautsprechern ausf√ºhren.
          default: disable_custom_actions
          selector:
            select:
              options:
                - label: Benutzerdefinierte Aktionen aktivieren
                  value: "enable_custom_actions"
                - label: Benutzerdefinierte Aktionen deaktivieren
                  value: "disable_custom_actions"
        custom_actions:
          name: Benutzerdefinierte Aktionen
          description: >
            Gib die benutzerdefinierten Aktionen an, die ausgef√ºhrt werden sollen.
          default: []
          selector:
            action:
    global_conditions_settings:
      name: "Globale Bedingungen"
      icon: mdi:earth
      collapsed: true
      input:
        global_conditions:
          name: Globale Bedingungen
          description: >
            Gib globale Bedingungen an, die erf√ºllt sein m√ºssen, damit die Automatisierung ausgef√ºhrt wird.
          default: []
          selector:
            condition:
mode: single
max_exceeded: silent

variables:
  trigger_state: !input trigger_state
  trigger_state_entity: !input trigger_state_entity
  trigger_numeric_entity: !input trigger_numeric_entity
  above_state: !input above_state
  below_state: !input below_state
  time_delay_state: !input time_delay_state
  include_notify: !input include_notify
  notify_device: !input notify_device
  notify_title: !input notify_title
  notify_message: !input notify_message
  # iOS-spezifische Variablen auskommentiert:
  # notify_interruption_level: !input notify_interruption_level
  # notify_sound: !input notify_sound
  notify_data: !input notify_data
  notify_channel: !input notify_channel
  # Benachrichtigungszonenoption auskommentiert:
  # include_notify_zone: !input include_notify_zone
  # notify_zone: !input notify_zone
  # Permanente Benachrichtigung: Titel und Nachricht werden von notify_title und notify_message √ºbernommen.
  include_custom_actions: !input include_custom_actions
  custom_actions: !input custom_actions
  # Zeitbezogene Variablen auskommentiert:
  # include_time: !input include_time
  # after_time: !input after_time
  # before_time: !input before_time
  # weekday_options: !input weekday_options
  global_conditions: !input global_conditions

  device_message_data: >-
    {% set message = namespace(data={}) %}
    {% set push = namespace(data={}) %}
    {# iOS-spezifische Optionen auskommentiert #}
    {# if notify_interruption_level in ['active', 'critical', 'time-sensitive', 'passive'] %}
      {# set push.data = dict(push.data, **{ 'interruption-level': notify_interruption_level }) #}
    {# endif #}
    {# if notify_sound != [] %}
      {# set push.data = dict(push.data, **{ 'sound': notify_sound }) #}
    {# endif #}
    {% if push.data %}
      {% set message.data = dict(message.data, **{ 'push': push.data }) %}
    {% endif %}
    {% if 'high_priority' in notify_data %}
      {% set message.data = dict(message.data, **{ 'ttl': 0, 'priority': 'high' }) %}
    {% endif %}
    {% if 'channel' in notify_data %}
      {% set message.data = dict(message.data, **{ 'channel': notify_channel }) %}
    {% endif %}
    {% if 'sticky' in notify_data %}
      {% set message.data = dict(message.data, **{
          'sticky': "true",
          'actions': [
              {'action': notify_channel ~ '_dismiss', 'title': 'L√∂schen'}
          ]
      }) %}
    {% endif %}

    {{ message.data }}

  filtered_devices: "{{ notify_device }}"

triggers:
  - trigger: state
    id: "t0"
    entity_id: !input trigger_state_entity
    for: !input time_delay_state
  - trigger: state
    id: "t1"
    entity_id: !input trigger_state_entity
    to: !input trigger_state
    for: !input time_delay_state
  - trigger: numeric_state
    id: "t2"
    entity_id: !input trigger_numeric_entity
    above: !input above_state
    for: !input time_delay_state
  - trigger: numeric_state
    id: "t3"
    entity_id: !input trigger_numeric_entity
    below: !input below_state
    for: !input time_delay_state
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "{{ notify_channel}}_dismiss"
    id: clear_notification_trigger

condition:
  - condition: or
    conditions:
      - condition: and
        conditions:
          - condition: trigger
            id: 't0'
          - "{{ trigger_state == 'button_any_state' }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't1'
          - "{{ (trigger_state != 'button_any_state') or (trigger_state != 'numeric_state_above') or (trigger_state != 'numeric_state_below') or (trigger_state != 'numeric_state_above_below') }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't2'
          - "{{ (trigger_state == 'numeric_state_above') or (trigger_state == 'numeric_state_above_below') }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't3'
          - "{{ (trigger_state == 'numeric_state_below') or (trigger_state == 'numeric_state_above_below') }}"
      - condition: trigger
        id: clear_notification_trigger
  # Zeitbezogene Bedingungen auskommentiert:
  # - condition: or
  #   conditions:
  #     - "{{ include_time == 'time_disabled' }}"
  #     - condition: and
  #       conditions:
  #       - condition: time
  #         after: !input after_time
  #         before: !input before_time
  #         weekday: !input weekday_options
  #       - "{{ include_time == 'time_enabled' }}"
  - condition: and
    conditions: !input global_conditions

action:
  - if:
      - condition: trigger
        id: clear_notification_trigger
    then:
      - repeat:
          for_each: "{{ filtered_devices }}"
          sequence:
            - service: "{{ repeat.item }}"
              data:
                message: "clear_notification"
                data:
                  tag: !input notify_channel
    else:
      - alias: "Sende Android-Benachrichtigung"
        repeat:
          for_each: "{{ filtered_devices }}"
          sequence:
            - service: "{{ repeat.item }}"
              data:
                title: !input notify_title
                message: !input notify_message
                data: "{{ device_message_data }}"
      - alias: "Erstelle persistente Benachrichtigung"
        service: persistent_notification.create
        data:
          title: !input notify_title
          message: !input notify_message
          notification_id: !input notify_channel
      # TTS-Aktion auskommentiert:
      # - choose:
      #   - alias: "Pr√ºfe, ob TTS-Durchsage aktiviert ist"
      #     conditions:
      #       - "{{ include_tts_announcement == 'enable_tts_announcement' }}"
      #     sequence:
      #       - service: tts.speak
      #         target:
      #           entity_id: !input text_to_speech_engine
      #         data:
      #           media_player_entity_id: !input media_player
      #           message: !input notify_tts_message
      - choose:
        - alias: "F√ºhre benutzerdefinierte Aktion aus"
          conditions:
            - condition: template
              value_template: "{{ 'enable_custom_actions' in include_custom_actions }}"
          sequence: !input custom_actions
