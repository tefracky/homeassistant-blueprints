blueprint:
  source_url: "https://raw.githubusercontent.com/tefracky/homeassistant-blueprints/blueprints/automations/notifications-and-announcements.yaml"
  name: Benachrichtigungen & Durchsagen (Android + Persistent)
  description: >
    # 📢 Benachrichtigungen & Durchsagen
    
    **Version: 1.0**
    
    
    Lege deinen Auslöser fest und verbreite die Nachricht 💬🔉
    
    
    **Wenn dir meine Blueprints gefallen und du deine Unterstützung zeigen oder einfach Danke sagen möchtest,** [Hier klicken](https://www.paypal.com/donate/?hosted_button_id=WAZS3QSDTPGA8) 🙂
    
    <details>
    <summary><b>Der Automatisierungsprozess:</b> - Hier klicken, um weitere Details anzuzeigen</summary>
    
      - **Trigger Optionen:**
    
        - Gib den Zustandswechsel einer oder mehrerer Entitäten an, der die Automatisierung auslösen soll, und wähle diesen aus einer Dropdown-Liste aus. Falls der gewünschte Zustand nicht in der Liste verfügbar ist, kannst du auch einen eigenen benutzerdefinierten Zustand eingeben.
        - Optionen für Zustandsänderungen:
            - **Allgemeine Zustände:** Button oder beliebiger Zustand, AN, AUS, Nicht verfügbar oder Unbekannt
            - **Standortbezogene Zustände:** Zuhause oder Nicht zu Hause
            - **Numerische Zustände:** Numerischer Zustand – Über, Numerischer Zustand – Unter oder Numerischer Zustand – Über & Unter
    
      - **Benachrichtigungsoptionen:**
    
        - Wähle, ob Nachrichten an ein oder mehrere Geräte gesendet werden sollen (kompatibel mit Apple iOS und Android).
        - Bestimme, ob deine Benachrichtigungen direkt in der Home Assistant‑Benutzeroberfläche angezeigt werden sollen.
        - Entscheide, ob eine Text-to-Speech-Durchsage an die ausgewählten Medienplayer erfolgen soll.
        - Lege fest, ob eine benutzerdefinierte Aktion ausgeführt werden soll.
    
      - **Zeitbasierte Automatisierung:**
    
        - Lege exakte Start- und Endzeiten sowie die Wochentage fest, an denen die Automatisierung aktiv sein soll.
    
      - **Benutzerdefinierte Bedingungen:**
    
        - Füge beliebige zusätzliche Bedingungen hinzu, um den Automatisierungsprozess individuell anzupassen.
    
    </details>
    
    
    Brauchst du Hilfe? Sieh dir unsere FAQ an: [Hier klicken](https://community.home-assistant.io/t/notifications-announcements/728100/2?u=blacky)
    
    Lass uns wissen, was du von diesem Blueprint hältst und unterstütze die Community inklusive Updates: [Hier klicken](https://community.home-assistant.io/t/notifications-announcements/728100?u=blacky)
  domain: automation
  input:
    trigger_settings:
      name: "Trigger"
      icon: mdi:cog-outline
      collapsed: true
      input:
        trigger_state:
          name: Trigger - Zustand
          description: >
            Bitte wähle den Zustand, der den Trigger auslösen soll.
            Du kannst aus den zehn verfügbaren Optionen im Dropdown-Menü wählen.
            Falls deine Option nicht vorhanden ist, gib einfach deinen gewünschten Zustand ein und klicke auf Speichern.
            
            1 - Button Oder Beliebiger Zustand
            
            2 - AN
            
            3 - AUS
            
            4 - Nicht verfügbar
            
            5 - Unbekannt
            
            6 - Zuhause
            
            7 - Nicht zu Hause
            
            8 - Numerischer Zustand – Über
            
            9 - Numerischer Zustand – Unter
            
            10 - Numerischer Zustand – Über & Unter
            
            Das Nummerierungssystem erleichtert die Navigation und hilft dir, die Einstellungen zu identifizieren.
          default: button_any_state
          selector:
            select:
              custom_value: true
              mode: dropdown
              options:
                - label: "1 - Button Oder Beliebiger Zustand"
                  value: "button_any_state"
                - label: "2 - AN"
                  value: "on"
                - label: "3 - AUS"
                  value: "off"
                - label: "4 - Nicht verfügbar"
                  value: "unavailable"
                - label: "5 - Unbekannt"
                  value: "unknown"
                - label: "6 - Zuhause"
                  value: "home"
                - label: "7 - Nicht zu Hause"
                  value: "not_home"
                - label: "8 - Numerischer Zustand – Über"
                  value: "numeric_state_above"
                - label: "9 - Numerischer Zustand – Unter"
                  value: "numeric_state_below"
                - label: "10 - Numerischer Zustand – Über & Unter"
                  value: "numeric_state_above_below"
        trigger_state_entity:
          name: Zustands-Entitäten
          description: >
            **Verwendet in den Optionen 1, 2, 3, 4, 5, 6 oder 7.**
            Gib die Entitäten an, die den Zustandswechsel auslösen.
          default: []
          selector:
            entity:
              multiple: true
        trigger_numeric_entity:
          name: Numerische Zustands-Entitäten
          description: >
            **Verwendet in den Optionen 8, 9 oder 10.**
            Gib die Entitäten an, die den numerischen Zustandswechsel überwachen.
          default: []
          selector:
            entity:
              multiple: true
        above_state:
          name: Numerischer Zustand – Über Option
          description: >
            **Verwendet in den Optionen 8 oder 10.**
            Setze den Schwellenwert, bei dessen Überschreitung der numerische Zustand den festgelegten Wert überschreitet.
          default: 0
          selector:
            number:
              min: -20
              max: 100
              step: 1
              unit_of_measurement: Wert
        below_state:
          name: Numerischer Zustand – Unter Option
          description: >
            **Verwendet in den Optionen 9 oder 10.**
            Setze den Schwellenwert, bei dessen Unterschreitung der numerische Zustand den festgelegten Wert unterschreitet.
          default: 0
          selector:
            number:
              min: -20
              max: 100
              step: 1
              unit_of_measurement: Wert
        time_delay_state:
          name: Zeitverzögerung
          description: >
            **Verwendet in allen Optionen.**
            Bestimme die Dauer, die der Triggerzustand kontinuierlich bestehen muss, bevor die Automatisierung ausgeführt wird.
          default:
            hours: 0
            minutes: 0
            seconds: 0
          selector:
            duration:
    device_notify_settings:
      name: "Benachrichtigungen (Mobil und Persistent)"
      icon: mdi:devices
      collapsed: true
      input:
        include_notify:
          name: Mobile App Benachrichtigungsoption
          description: >
            Diese Option ist immer aktiviert, um Benachrichtigungen an die ausgewählten Geräte zu senden.
          default: enable_mobile_app_notify
          selector:
            select:
              options:
                - label: Mobile App Benachrichtigungsoption aktivieren
                  value: "enable_mobile_app_notify"
                - label: Mobile App Benachrichtigungsoption deaktivieren
                  value: "disable_mobile_app_notify"
        notify_device:
          name: Geräte zur Benachrichtigung
          description: >
            Wähle die Geräte aus, die benachrichtigt werden sollen, wenn die Automatisierung ausgelöst wird.
          default:
            - 7b4588bc469f471e30087c5757f2ebf4
            - 30d663ef8b06c87a5bdb80a56af74b15
            - e0f19df8be795d8d5867ccf822025697
            - 0cfbf22f9dc76ecf11f78017669b1d51
            - 170f72bbcf6e90b79e776d8511fc2419
          selector:
            device:
              filter:
                - integration: mobile_app
              multiple: true
        notify_title:
          name: Benachrichtigungstitel
          description: >
            Gib den Titel der Benachrichtigung ein, der sowohl für die Android-Benachrichtigung als auch für die persistente Benachrichtigung in der UI verwendet wird.
          default: "📢 Gebe hier den Benachrichtigungstitel ein"
          selector: 
            text:
        notify_message:
          name: Benachrichtigungsnachricht
          description: >
            Gib die Nachricht der Benachrichtigung ein, die sowohl für die Android-Benachrichtigung als auch für die persistente Benachrichtigung in der UI verwendet wird.
          default: "Gebe hier die Benachrichtigungsnachricht ein 🙂"
          selector:
            text:
        # iOS-spezifische Optionen auskommentiert:
        # notify_interruption_level:
        #   name: Interruption Level - iOS Only
        #   description: >
        #     Auf Geräten mit iOS 15 und höher kannst du das Interruption Level deiner Benachrichtigungen konfigurieren,
        #     um sicherzustellen, dass sie entsprechend deiner Präferenzen zugestellt werden.
        #   default: active
        #   selector:
        #     select:
        #       mode: dropdown
        #       options:
        #         - label: Standard
        #           value: "active"
        #         - label: Kritische Benachrichtigungen
        #           value: "critical"
        #         - label: Zeitkritische Benachrichtigungen
        #           value: "time-sensitive"
        #         - label: Stille Benachrichtigungen ohne Bildschirmaktivierung
        #           value: "passive"
        # notify_sound:
        #   name: Benachrichtigungston - iOS Only
        #   description: >
        #     Die Home Assistant App für iOS bietet integrierte Benachrichtigungstöne. Hier kannst du auch benutzerdefinierte Töne angeben.
        #   default: []
        #   selector:
        #     text:
        notify_data:
          name: "Android-spezifische Optionen (Optional)"
          description: >
            **Optionen für Android (Optional):**
            - **High Priority**: Benachrichtigungen werden sofort zugestellt, um sicherzustellen, dass wichtige Meldungen umgehend empfangen werden.
            - **Sticky Notification**: Wichtige Meldungen bleiben in der Benachrichtigungsleiste, bis sie aktiv entfernt werden.
            - **Notification Channel**: Organisiert verschiedene Benachrichtigungseinstellungen (Töne, Vibrationen etc.). Diese Option wird immer genutzt und erfordert die Eingabe eines Channel-Namens.
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: Hochpriorität
                  value: "high_priority"
                - label: Sticky Notification
                  value: "sticky"
        notify_channel:
          name: Notification Channel – Android & Persistent
          description: >
            Gib den Namen des Notification Channels ein. Dieser Channel wird auch als Tag für die persistente Benachrichtigung verwendet.
            Diese Eingabe ist stets erforderlich. Falls du noch keinen Channel hast, wird dieser beim ersten Senden der Benachrichtigung erstellt und kann anschließend konfiguriert werden.
            Empfohlenes Icon: mdi:radio
          default: "default-channel"
          selector:
            text:
        # Use The Notify Zone Option auskommentiert:
        # include_notify_zone:
        #   name: Benachrichtigungszonenoption (Optional)
        #   description: >
        #     Home Assistant kann den Standort deiner Geräte verfolgen und Benachrichtigungen nur an Geräte in einem bestimmten Bereich senden.
        #   default: zone_disabled
        #   selector:
        #     select:
        #       options:
        #         - label: Zone-Option aktivieren
        #           value: "zone_enabled"
        #         - label: Zone-Option deaktivieren
        #           value: "zone_disabled"
        # notify_zone:
        #   name: Benachrichtigungszone
        #   description: >
        #     Wähle die Zone aus, an die die Benachrichtigung gesendet werden soll.
        #   default: []
        #   selector:
        #     entity:
        #       filter:
        #         domain: zone
    # Feste (persistente) Benachrichtigung (UI) auskommentiert, da Titel und Nachricht mit den Android-Benachrichtigungen synchronisiert werden:
    # persistent_notify_settings:
    #   name: "Benachrichtigungen (UI)"
    #   icon: mdi:bell-outline
    #   collapsed: true
    #   input:
    #     include_persistent_notification:
    #       name: UI-Benachrichtigungsoption (Optional)
    #       description: >
    #         Aktiviert die Anzeige von Benachrichtigungen direkt in der Home Assistant Benutzeroberfläche.
    #       default: enable_persistent_notification
    #       selector:
    #         select:
    #           options:
    #             - label: UI-Benachrichtigungen aktivieren
    #               value: "enable_persistent_notification"
    #             - label: UI-Benachrichtigungen deaktivieren
    #               value: "disabled_persistent_notification"
    #     persistent_title:
    #       name: Titel
    #       description: >
    #         Gib den Titel der UI-Benachrichtigung ein.
    #       default: "📢 Gebe hier den UI-Titel ein"
    #       selector:
    #         text:
    #     persistent_message:
    #       name: Nachricht
    #       description: >
    #         Gib die Nachricht der UI-Benachrichtigung ein.
    #       default: "Gebe hier die UI-Nachricht ein 🙂"
    #       selector:
    #         text:
    # Text-to-Speech Optionen auskommentiert:
    # tts_notify_settings:
    #   name: "Text-to-Speech Durchsage"
    #   icon: mdi:bullhorn-outline
    #   collapsed: true
    #   input:
    #     include_tts_announcement:
    #       name: Text-to-Speech Durchsageoption (Optional)
    #       description: >
    #         Aktiviert die Text-to-Speech Durchsage an ausgewählten Medienplayern.
    #       default: disable_tts_announcement
    #       selector:
    #         select:
    #           options:
    #             - label: Text-to-Speech Durchsagen aktivieren
    #               value: "enable_tts_announcement"
    #             - label: Text-to-Speech Durchsagen deaktivieren
    #               value: "disable_tts_announcement"
    #     text_to_speech_engine:
    #       name: Text-to-Speech Dienstanbieter
    #       description: >
    #         Wähle den Text-to-Speech Dienstanbieter aus.
    #       default: []
    #       selector:
    #         entity:
    #           filter:
    #             domain: tts
    #     media_player:
    #       name: Medienplayer
    #       description: >
    #         Wähle die Medienplayer aus, die die Text-to-Speech Durchsage abspielen sollen.
    #       default: []
    #       selector:
    #         entity:
    #           filter:
    #             domain: media_player
    #           multiple: true
    #     notify_tts_message:
    #       name: Durchsagenachricht
    #       description: >
    #         Gib die Nachricht für die Text-to-Speech Durchsage ein.
    #       default: "Gebe hier die TTS-Nachricht ein"
    #       selector:
    #         text:
    #           multiline: true
    # Zeitbezogene Optionen auskommentiert:
    # time_settings:
    #   name: "Zeit"
    #   icon: mdi:clock-outline
    #   collapsed: true
    #   input:
    #     include_time:
    #       name: Zeitoptionen (Optional)
    #       description: >
    #         Nutze die Optionen Startzeit, Endzeit und Wochentage, um die Automatisierung auf bestimmte Zeiten zu beschränken.
    #       default: time_disabled
    #       selector:
    #         select:
    #           options:
    #             - label: Zeitoptionen aktivieren
    #               value: "time_enabled"
    #             - label: Zeitoptionen deaktivieren
    #               value: "time_disabled"
    #     after_time:
    #       name: Startzeit
    #       description: >
    #         Lege die Startzeit fest.
    #       default: 00:00:00
    #       selector:
    #         time:
    #     before_time:
    #       name: Endzeit
    #       description: >
    #         Lege die Endzeit fest.
    #       default: 00:00:00
    #       selector:
    #         time:
    #     weekday_options:
    #       name: Wochentage
    #       description: >
    #         Wähle die Wochentage aus, an denen die Automatisierung aktiv sein soll.
    #       default:
    #         - mon
    #         - tue
    #         - wed
    #         - thu
    #         - fri
    #         - sat
    #         - sun
    #       selector:
    #         select:
    #           multiple: true
    #           mode: list
    #           options:
    #             - label: Montag
    #               value: "mon"
    #             - label: Dienstag
    #               value: "tue"
    #             - label: Mittwoch
    #               value: "wed"
    #             - label: Donnerstag
    #               value: "thu"
    #             - label: Freitag
    #               value: "fri"
    #             - label: Samstag
    #               value: "sat"
    #             - label: Sonntag
    #               value: "sun"
    action_settings:
      name: "Actions Buttons"
      icon: mdi:gesture-tap
      collapsed: true
      input:
        include_action_buttons:
          name: Notify - Action Buttons Options (Optional)
          description: >
            Enable the action buttons you would like to use. These buttons will be shown in the notification, allowing you to perform actions when clicked.


            **NOTE** - You do not need to select any notification action buttons to execute a action.
            If you prefer to run a action without using any action buttons, simply enable any **Auto Action** located in the **Actions** section below.


            ⚠️ Enter the names for all enabled **Action Buttons** below, including the **Cancel Action Button**.
            Missing any button names may prevent the automation from functioning correctly and could result in not receiving the notification.
          default: []
          selector:
            select:
              options:
                - label: Enable action button 1
                  value: "enable_action_button_1"
                - label: Enable action button 2
                  value: "enable_action_button_2"
                - label: Enable action button 3
                  value: "enable_action_button_3"
              multiple: true
        action_button_1:
          name: Action Button 1
          description: >
            Enter the button name to be displayed in the notification.
            This button will execute all actions entered into the **Action 1** input located in the **Actions** section below.
          default: []
          selector:
            text:
        action_button_2:
          name: Action Button 2
          description: >
            Enter the button name to be displayed in the notification.
            This button will execute all actions entered into the **Action 2** input located in the **Actions** section below.
          default: []
          selector:
            text:
        action_button_3:
          name: Action Button 3
          description: >
            Enter the button name to be displayed in the notification.
            This button will execute all actions entered into the **Action 3** input located in the **Actions** section below.
          default: []
          selector:
            text:
        action_button_stop:
          name: Cancel Action Button
          description: >
            Enter the Cancel button name to be displayed in the notification.
            This button will cancel all actions and stop the automation.
            It will be automatically included in the notification if you have enabled an action button above.
          default: Cancel
          selector:
            text:
    auto_action_settings:
      name: "Actions"
      icon: mdi:code-tags
      collapsed: true
      input:
        include_auto_actions:
          name: Use The Auto Action Options (Optional)
          description: >
            Enabling the auto option will trigger the **Actions** below when the entity changes to its specified state.


            When using action buttons in a notification, enabling an auto action is not necessary for the actions to work, as pressing an action button will execute the selected action.
            However, if you miss the notification and don't press an action button, enabling the auto action option ensures the start actions will still run after the specified time delay.
          default: []
          selector:
            select:
              options:
                - label: Enable auto action 1
                  value: "enable_action_1"
                - label: Enable auto action 2
                  value: "enable_action_2"
                - label: Enable auto action 3
                  value: "enable_action_3"
              multiple: true
        action_1:
          name: Action 1
          description: >
            Enter the actions you want to run when the entity changes state.


            These actions are also linked to the **Notify - Action Button 1** input located in the **Actions Buttons** section above.
          default: []
          selector:
            action:
        action_2:
          name: Action 2
          description: >
            Enter the actions you want to run when the entity changes state.


            These actions are also linked to the **Notify - Action Button 2** input located in the **Actions Buttons** section above.
          default: []
          selector:
            action:
        action_3:
          name: Action 3
          description: >
            Enter the actions you want to run when the entity changes state.

          
            These actions are also linked to the **Notify - Action Button 3** input located in the **Actions Buttons** section above.
          default: []
          selector:
            action:
    custom_actions_settings:
      name: "Benutzerdefinierte Aktionen"
      icon: mdi:code-tags
      collapsed: true
      input:
        include_custom_actions:
          name: Benutzerdefinierte Aktionsoption (Optional)
          description: >
            Passe deine Automatisierung mit beliebigen Aktionen an.
            Zum Beispiel kannst du Durchsagen über spezielle Lautsprecher ausführen.
          default: disable_custom_actions
          selector:
            select:
              options:
                - label: Benutzerdefinierte Aktionen aktivieren
                  value: "enable_custom_actions"
                - label: Benutzerdefinierte Aktionen deaktivieren
                  value: "disable_custom_actions"
        custom_actions:
          name: Benutzerdefinierte Aktionen
          description: >
            Gib die benutzerdefinierten Aktionen ein, die ausgeführt werden sollen.
          default: []
          selector:
            action:
    global_conditions_settings:
      name: "Globale Bedingungen"
      icon: mdi:earth
      collapsed: true
      input:
        global_conditions:
          name: Globale Bedingungen
          description: >
            Gib globale Bedingungen ein, die erfüllt sein müssen, damit die Automatisierung ausgeführt wird.
          default: []
          selector:
            condition:
mode: single
max_exceeded: silent

variables:
  trigger_state: !input trigger_state
  trigger_state_entity: !input trigger_state_entity
  trigger_numeric_entity: !input trigger_numeric_entity
  above_state: !input above_state
  below_state: !input below_state
  time_delay_state: !input time_delay_state
  include_notify: !input include_notify
  notify_device: !input notify_device
  notify_title: !input notify_title
  notify_message: !input notify_message
  # iOS-spezifische Variablen auskommentiert:
  # notify_interruption_level: !input notify_interruption_level
  # notify_sound: !input notify_sound
  notify_data: !input notify_data
  notify_channel: !input notify_channel
  # Benachrichtigungszonenoption auskommentiert:
  # include_notify_zone: !input include_notify_zone
  # notify_zone: !input notify_zone
  # Permanente Benachrichtigung: Titel und Nachricht werden von notify_title und notify_message übernommen.
  include_action_buttons: !input include_action_buttons
  action_button_1: !input action_button_1
  action_button_2: !input action_button_2
  action_button_3: !input action_button_3
  action_button_stop: !input action_button_stop
  include_auto_actions: !input include_auto_actions
  action_1: !input action_1
  action_2: !input action_2
  action_3: !input action_3
  include_custom_actions: !input include_custom_actions
  custom_actions: !input custom_actions
  # Zeitbezogene Variablen auskommentiert:
  # include_time: !input include_time
  # after_time: !input after_time
  # before_time: !input before_time
  # weekday_options: !input weekday_options
  global_conditions: !input global_conditions

  device_message_data: >-
    {% set message = namespace(data={}) %}
    {% set push = namespace(data={}) %}
    {% set actions = [] %}
    {# iOS-spezifische Optionen auskommentiert #}
    {# if notify_interruption_level in ['active', 'critical', 'time-sensitive', 'passive'] %}
      {# set push.data = dict(push.data, **{ 'interruption-level': notify_interruption_level }) #}
    {# endif #}
    {# if notify_sound != [] %}
      {# set push.data = dict(push.data, **{ 'sound': notify_sound }) #}
    {# endif #}
    {% if push.data %}
      {% set message.data = dict(message.data, **{ 'push': push.data }) %}
    {% endif %}
    {% if 'high_priority' in notify_data %}
      {% set message.data = dict(message.data, **{ 'ttl': 0, 'priority': 'high' }) %}
    {% endif %}
    {% set message.data = dict(message.data, **{ 'channel': notify_channel }) %}
    {% set message.data = dict(message.data, **{ 'tag': notify_channel }) %}
    {% if 'enable_action_button_1' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_1', 'title': action_button_1 }] %}
    {% endif %}
    {% if 'enable_action_button_2' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_2', 'title': action_button_2 }] %}
    {% endif %}
    {% if 'enable_action_button_3' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_3', 'title': action_button_3 }] %}
    {% endif %}
    {% if 'sticky' in notify_data %}
      {% set message.data = dict(message.data, **{ 'sticky': "true" }) %}
      {% set actions = actions + [{'action': 'dismiss', 'title': 'Löschen'}] %}
    {% endif %}
    {% if actions | length > 0 %}
      {% set message.data = dict(message.data, **{ 'actions': actions }) %}
    {% endif %}
    {{ message.data }}

  # filtered_devices: >
  #   {% if include_notify_zone == 'zone_enabled' %}
  #     {% set zone_name = notify_zone.split('.')[1] %}
  #     {% set device_trackers = notify_device | map('device_entities') | list %}
  #     {% set devices_in_zone = expand(device_trackers)
  #       | selectattr('state', 'eq', zone_name)
  #       | map(attribute='entity_id')
  #       | list %}
  #     {{ devices_in_zone }}
  #   {% else %}
  #     {{ notify_device }}
  #   {% endif %}

  filtered_devices: "{{ notify_device }}"

triggers:
  - trigger: state
    id: "t0"
    entity_id: !input trigger_state_entity
    for: !input time_delay_state
  - trigger: state
    id: "t1"
    entity_id: !input trigger_state_entity
    to: !input trigger_state
    for: !input time_delay_state
  - trigger: numeric_state
    id: "t2"
    entity_id: !input trigger_numeric_entity
    above: !input above_state
    for: !input time_delay_state
  - trigger: numeric_state
    id: "t3"
    entity_id: !input trigger_numeric_entity
    below: !input below_state
    for: !input time_delay_state
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "action_button_1"
      tag: !input notify_channel
    id: action_button_1
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "action_button_2"
      tag: !input notify_channel
    id: action_button_2
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "action_button_3"
      tag: !input notify_channel
    id: action_button_3
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "dismiss"
      tag: !input notify_channel
    id: clear_notification_trigger

condition:
  - condition: or
    conditions:
      - condition: and
        conditions:
          - condition: trigger
            id: 't0'
          - "{{ trigger_state == 'button_any_state' }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't1'
          - "{{ (trigger_state != 'button_any_state') or (trigger_state != 'numeric_state_above') or (trigger_state != 'numeric_state_below') or (trigger_state != 'numeric_state_above_below') }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't2'
          - "{{ (trigger_state == 'numeric_state_above') or (trigger_state == 'numeric_state_above_below') }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't3'
          - "{{ (trigger_state == 'numeric_state_below') or (trigger_state == 'numeric_state_above_below') }}"
      - condition: trigger
        id: action_button_1
      - condition: trigger
        id: action_button_2
      - condition: trigger
        id: action_button_3
      - condition: trigger
        id: clear_notification_trigger
  # Zeitbezogene Bedingungen auskommentiert:
  # - condition: or
  #   conditions:
  #     - "{{ include_time == 'time_disabled' }}"
  #     - condition: and
  #       conditions:
  #       - condition: time
  #         after: !input after_time
  #         before: !input before_time
  #         weekday: !input weekday_options
  #       - "{{ include_time == 'time_enabled' }}"
  - condition: and
    conditions: !input global_conditions

action:
  - choose:
    - alias: "Check if action button 1 is pressed"
      conditions:
        - condition: trigger
          id: action_button_1
      sequence: !input action_1
    - alias: "Check if action button 2 is pressed"
      conditions:
        - condition: trigger
          id: action_button_2
      sequence: !input action_2
    - alias: "Check if action button 3 is pressed"
      conditions:
        - condition: trigger
          id: action_button_3
      sequence: !input action_3
    - alias: "Check if delete button is pressed"
      conditions:
        - condition: trigger
          id: clear_notification_trigger
      sequence:
        - repeat:
            for_each: "{{ filtered_devices }}"
            sequence:
              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                data:
                  message: "clear_notification"
                  data:
                    tag: !input notify_channel
    default:
      - alias: "Sende eine Benachrichtigung an jedes Gerät"
        repeat:
          for_each: "{{ filtered_devices }}"
          sequence:
            - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
              data:
                title: !input notify_title
                message: !input notify_message
                data: "{{ device_message_data }}"
      - alias: "Erstelle persistente Benachrichtigung"
        service: persistent_notification.create
        data:
          title: !input notify_title
          message: !input notify_message
          notification_id: !input notify_channel
      # TTS-Aktion auskommentiert:
      # - choose:
      #   - alias: "Prüfe, ob TTS-Durchsage aktiviert ist"
      #     conditions:
      #       - "{{ include_tts_announcement == 'enable_tts_announcement' }}"
      #     sequence:
      #       - service: tts.speak
      #         target:
      #           entity_id: !input text_to_speech_engine
      #         data:
      #           media_player_entity_id: !input media_player
      #           message: !input notify_tts_message
      - if:
          - condition: template
            alias: "Führe benutzerdefinierte Aktion aus"
            value_template: "{{ 'enable_custom_actions' in include_custom_actions }}"
        then: !input custom_actions
