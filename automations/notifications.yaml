blueprint:
  source_url: "https://raw.githubusercontent.com/tefracky-organization/homeassistant-blueprints/refs/heads/blueprints/automations/notifications.yaml"
  name: Benachrichtigungen (Android + Persistent)
  description: >
    # ðŸ“¢ Benachrichtigungen

    ## **Version 1.6**

    - ðŸ”„ **Auto-Flag umbenannt und Default geÃ¤ndert**  
      `send_car` heiÃŸt jetzt `send_to_car` (Standard: false) und sendet nur noch an das GerÃ¤t  
      7b4588bc469f471e30087c5757f2ebf4 (EOS), wenn aktiviert.

    - âž• **Neue Arbeits-Benachrichtigung**  
      `send_to_work` (Standard: false) ermÃ¶glicht nun das HinzufÃ¼gen der ArbeitsgerÃ¤te  
      e0f19df8be795d8d5867ccf822025697 (Oliver Handy Arbeit) und  
      170f72bbcf6e90b79e776d8511fc2419 (Tina Tablet Arbeit).

    - ðŸ›  **Notify-Devices-Logik aufgeteilt**  
      Basis-Liste enthÃ¤lt nur PrivatgerÃ¤te. Arbeits- und Auto-GerÃ¤te werden nun getrennt nach ihren Flags hinzugefÃ¼gt.

    ## **Version 1.5**

    Sende smarte Benachrichtigungen bei definierten AuslÃ¶sern â€“ sowohl an dein Android-GerÃ¤t als auch als permanente Mitteilung in der Home Assistantâ€‘OberflÃ¤che.

    Mit dieser Blueprintâ€‘Vorlage kannst du flexibel Trigger definieren (z.â€¯B. ZustÃ¤nde, numerische Werte oder Zeitpunkte) und daraufhin Nachrichten verschicken â€“ inklusive optionaler Sprachansage, interaktiver Aktionsâ€‘Buttons und erweiterter Bedingungslogik.

    > **âš™ï¸ Voraussetzung:** Home Assistant **ab Versionâ€¯2024.10**, damit die neue Listenâ€‘Mergeâ€‘Funktion fÃ¼r Trigger verwendet werden kann.

    - **ðŸ§² Trigger & EndzustÃ¤nde**:
      - Nutze den **Trigger Selector**, um beliebige Ereignisse per UI zu definieren.
      - Mehrere Trigger sind gleichzeitig mÃ¶glich und werden nun **dynamisch flach zusammengefÃ¼hrt** (ohne versteckte UNDâ€‘Verschachtelung).
      - Definiere einen Endzustand (z.â€¯B. zum Entfernen einer Notification) â€“ inklusive **zusÃ¤tzlicher Bedingungen**.
      - UnterstÃ¼tzt **Bedingungen beim Triggern und LÃ¶schen**, um nur bei bestimmten Konstellationen auszulÃ¶sen.

    - **ðŸ“² Benachrichtigungen**:
      - Nachrichten an MobilgerÃ¤te senden.
      - Als persistente UIâ€‘Mitteilungen anzeigen.
      - Integrierte Textâ€‘toâ€‘Speech und Aktionen mÃ¶glich.

    - **ðŸ•¹ Aktionsâ€‘Buttons**:
      - ErgÃ¤nze individuell konfigurierbare Buttons direkt in der Notification.
      - Jeder Button feuert nun als **eigenstÃ¤ndiger Trigger**, ohne dass andere Bedingungen gleichzeitig erfÃ¼llt sein mÃ¼ssen.

    - **â›” Bedingungen & Kontrolle**:
      - Lege globale Bedingungen fest, unter denen die Automation Ã¼berhaupt ausgefÃ¼hrt werden darf.
      - ZusÃ¤tzliche Bedingungen **nur fÃ¼r Triggerâ€‘ oder LÃ¶schâ€‘Ereignisse** definierbar.


    ## Changelog

    **1.5**: Dynamische Trigger-Listen flach zusammenfÃ¼hren (Trigger Merge)

    - ðŸ†• **Trigger Merge-Support (HA â‰¥â€¯2024.10)**
      - Neue `min_version: '2024.10.0'` fÃ¼r die Blueprintâ€‘Definition hinzugefÃ¼gt, um die native Listenâ€‘Merge-Funktion zu nutzen.  
      - `dynamic_trigger` und `clear_trigger` werden jetzt per `- triggers: !input â€¦` direkt in die flache `triggers:`-Liste eingefÃ¼gt, statt verschachtelt â€“ dadurch entfÃ¤llt die unerwÃ¼nschte UNDâ€‘Logik.

    - âœ‚ï¸ **Verschachtelte `triggers:`-BlÃ¶cke entfernt**
      - Alte nested-Trigger-Abschnitte gelÃ¶scht, um Klarheit und Vorhersagbarkeit zu verbessern.

    - âœ… **Button-Events feuern einzeln**
      - Alle mobilen Appâ€‘Action-Buttons (`action_button_1`, `action_button_2`, `action_button_3`, `dismiss`) stehen jetzt als eigenstÃ¤ndige Trigger-EintrÃ¤ge in der Liste und reagieren punktgenau auf das jeweilige Event.

    - ðŸ›  **Fehlerbehebung & KompatibilitÃ¤t**
      - Vermeidet das Verschwinden von Button-Triggern durch falsche Kombination mit dynamischen Trigger-Bedingungen.
      - Blueprint ist ab jetzt nur noch auf HA-Instanzen mit Version 2024.10 oder neuer lauffÃ¤hig.

    > **Hinweis:** Nach dem Update der Blueprint unter **Konfiguration â†’ Automatisierungen â†’ Neu laden** die betroffenen Automationen neu speichern, damit die geÃ¤nderten Trigger korrekt aktiviert werden.


    **1.4**: ZusÃ¤tzliche Bedingungen fÃ¼r Trigger- und Endzustand

    - âœ… **Neue Bedingungsoptionen hinzugefÃ¼gt:**
      - `trigger_conditions`: ErmÃ¶glicht es, nur dann Benachrichtigungen zu senden, wenn zusÃ¤tzliche Bedingungen beim Trigger erfÃ¼llt sind.
      - `clear_conditions`: ErmÃ¶glicht das automatische LÃ¶schen von Benachrichtigungen nur bei erfÃ¼llten Bedingungen (z.â€¯B. Zustand + Zeitspanne + Anwesenheit).

    - ðŸ§  **Intelligentere Ablaufsteuerung:**
      - Die Bedingungen wurden in die `choose:`-Logik integriert und verhindern zuverlÃ¤ssig das AusfÃ¼hren der Hauptaktionen bei nicht erfÃ¼llten Voraussetzungen.

    - ðŸ§¼ **Klarere Struktur:**
      - Trennung der Bedingungslogik fÃ¼r Trigger und EndzustÃ¤nde â€“ mehr FlexibilitÃ¤t, bessere Lesbarkeit.

    - ðŸ›  **Fehlerbehebung:**
      - Korrektur der Trigger-ID fÃ¼r den Button â€žLÃ¶schenâ€œ zu `clear_notification_button`, um Konflikte mit `clear_notification_trigger` zu vermeiden.


    **1.3**: Verbesserungen an den Benachrichtigungsoptionen und der Benutzerfreundlichkeit

    - ðŸ›  **Neue Auswahl fÃ¼r Benachrichtigungsoptionen:**
      Die Auswahl fÃ¼r die mobile App-Benachrichtigungsoption (`include_notify`) wurde entfernt. Es werden jetzt immer Benachrichtigungen an MobilgerÃ¤te gesendet.

    - âœï¸ **Standardwerte aktualisiert:**
      Standardwerte fÃ¼r Titel und Nachricht der Benachrichtigung (`notify_title`, `notify_message`) wurden hinzugefÃ¼gt, um die Konfiguration zu erleichtern.

    - ðŸ“± **Android-spezifische Optionen erweitert:**
      ZusÃ¤tzliche Optionen fÃ¼r Android-Benachrichtigungen (`notify_data`) wie HochprioritÃ¤t und feste Benachrichtigungen wurden hinzugefÃ¼gt.

    - ðŸ”§ **Verbesserte Struktur:**
      Die YAML-Definition wurde optimiert, um die Lesbarkeit und Wartbarkeit zu verbessern.

    **1.2**: Benachrichtigungen senden und lÃ¶schen an Skripte ausgelagert

    - ðŸ—‘ **Refaktorierte LÃ¶schlogik:**
      Statt der bisherigen, manuellen Abfolge zum LÃ¶schen persistenter Benachrichtigungen wird nun das zentrale Skript `script.notification_delete` aufgerufen. Dies sorgt fÃ¼r einen klareren Ablauf und verbesserte Wartbarkeit.

    - ðŸ”” **Modularisierte Benachrichtigungsroutine:**
      Ein neuer Choose-Zweig â€žCheck if notification is enabledâ€œ Ã¼berprÃ¼ft, ob mobile App-Benachrichtigungen aktiviert sind und ob GerÃ¤te vorhanden sind, und lÃ¶st dann das Skript `script.notification_send` aus â€“ inklusive Ãœbergabe aller relevanten Parameter wie Titel, Nachricht, Daten und Aktions-Buttons.

    - ðŸ§¹ **Bereinigung der Legacy-Struktur:**
      Der bisher verwendete `default`-Block, der separate ZustÃ¤ndigkeiten fÃ¼r GerÃ¤tebenachrichtigungen und das Erstellen persistenter Nachrichten innehatte, wurde komplett entfernt, um Redundanzen abzubauen und die Logik zu vereinheitlichen.

    - âš™ï¸ **Integrierte benutzerdefinierte Aktionen:**
      Die Option, benutzerdefinierte Aktionen auszufÃ¼hren, bleibt erhalten â€“ in den neuen Benachrichtigungs-Branch integriert, um den Ablauf zu vereinheitlichen und die Konfiguration Ã¼bersichtlicher zu gestalten.

    **1.1**: Aktionen zu Benachrichtigungen hinzugefÃ¼gt

    - âœ¨ Umstellung auf `trigger:` Selector â€“ mehr FlexibilitÃ¤t, bessere UI.

    - âž• UnterstÃ¼tzung fÃ¼r **mehrere Trigger** gleichzeitig.

    - ðŸ§¼ Entfernt: Komplexe manuelle Zustandstyp-Auswahl.

    - ðŸ§½ Entfernt: `time_delay_state`, da dies direkt im Trigger mÃ¶glich ist (`for:`).

    - ðŸ§© Trigger & Endzustand in einer Gruppe zusammengefÃ¼hrt.

    **Vielen Dank an die ursprÃ¼nglichen Entwickler:**
      - [Notifications and Announcements](https://gist.github.com/Blackshome/180ca4a24af81cd5d843acfc039039bc)
      - [State Notification Actions](https://gist.github.com/Blackshome/06f6f28e76299267b813dac48608f549)
      - **Spende fÃ¼r den Entwickler:** [Hier klicken](https://www.paypal.com/donate/?hosted_button_id=WAZS3QSDTPGA8)
      - **FAQ & Hilfe:** [Zum Community-Thread](https://community.home-assistant.io/t/notifications-announcements/728100/2?u=blacky)

  domain: automation
  input:
    trigger_section:
      name: "ðŸ§² Trigger & Endzustand"
      icon: mdi:toggle-switch
      collapsed: false
      input:
        dynamic_trigger:
          name: Trigger-AuslÃ¶ser
          description: >
            WÃ¤hle die Trigger aus, die deine Automation starten sollen.
            Du kannst beliebige Trigger-Typen verwenden (z.â€¯B. ZustÃ¤nde, numerische Werte, Zeitpunkte, Events, etc.).
            Mehrere Trigger sind mÃ¶glich.
          selector:
            trigger:
        clear_trigger:
          name: Endzustand (optional)
          description: >
            Lege optional Trigger fÃ¼r das **automatische LÃ¶schen** der Benachrichtigung fest.
            Z.â€¯B. wenn eine EntitÃ¤t wieder den Zustand *OK* erreicht.
            Es muss zwingend **id: clear_notification_trigger** angegeben werden.
          default: []
          selector:
            trigger:
    device_notify_settings:
      name: "Benachrichtigungen (Mobil und Persistent)"
      icon: mdi:devices
      collapsed: true
      input:
        notify_title:
          name: Benachrichtigungstitel
          description: >
            Gib den Titel der Benachrichtigung ein, der sowohl fÃ¼r die Android-Benachrichtigung als auch fÃ¼r die persistente Anzeige in der UI verwendet wird.
          default: "ðŸ“¢ Gebe hier den Benachrichtigungstitel ein"
          selector:
            text:
        notify_message:
          name: Benachrichtigungsnachricht
          description: >
            Gib die Nachricht ein, die fÃ¼r die Benachrichtigung ausgesendet wird â€“ sowohl als Android-Meldung als auch in der persistenten Anzeige.
          default: "Gebe hier die Benachrichtigungsnachricht ein ðŸ™‚"
          selector:
            text:
              multiline: true
        notify_data:
          name: "Android-spezifische Optionen (Optional)"
          description: >
            **Optionen fÃ¼r Android (Optional):**
            - **HochprioritÃ¤t**: Benachrichtigungen werden sofort zugestellt, um wichtige Meldungen umgehend zu Ã¼bermitteln.
            - **Feste Benachrichtigung**: Wichtige Meldungen bleiben in der Benachrichtigungsleiste, bis sie aktiv entfernt werden.
            - **Benachrichtigungskanal**: Organisiert verschiedene Benachrichtigungseinstellungen (TÃ¶ne, Vibration etc.).
              Diese Option wird immer genutzt und erfordert die Eingabe eines Kanalnamens.
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: HochprioritÃ¤t
                  value: "high_priority"
                - label: Feste Benachrichtigung
                  value: "sticky"
        notify_tag:
          name: Benachrichtigungskanal â€“ Android & Persistent
          description: >
            Gib den Namen des Benachrichtigungskanals ein.
            Dieser Kanal wird auch als Tag fÃ¼r die persistente Benachrichtigung verwendet und â€“ falls noch nicht vorhanden â€“ beim ersten Senden der Benachrichtigung erstellt.
          default: "default_channel"
          selector:
            text:
        send_to_car:
          name: "Auto-Benachrichtigung aktivieren"
          description: >
            Wenn aktiviert (Standard: false) wird das GerÃ¤t 
            7b4588bc469f471e30087c5757f2ebf4 (EOS) in die Benachrichtigungsliste aufgenommen.
          default: false
          selector:
            boolean:
        send_to_work:
          name: "Arbeits-Benachrichtigung aktivieren"
          description: >
            Wenn aktiviert (Standard: false) werden die GerÃ¤te e0f19df8be795d8d5867ccf822025697 (Oliver Handy Arbeit) und 170f72bbcf6e90b79e776d8511fc2419 (Tina Tablet Arbeit) in die Benachrichtigungsliste aufgenommen.
          default: false
          selector:
            boolean:
    action_settings:
      name: "Aktions-Buttons"
      icon: mdi:gesture-tap
      collapsed: true
      input:
        include_action_buttons:
          name: Optionen fÃ¼r Aktions-Buttons (Optional)
          description: >
            Aktiviere die Aktions-Buttons, die in der Benachrichtigung angezeigt werden sollen, um Aktionen per Klick auszulÃ¶sen.

            **Hinweis**: Es ist nicht zwingend erforderlich, Aktions-Buttons zu verwenden, um eine Aktion auszufÃ¼hren.
            Falls du lieber eine automatische Aktion nutzen mÃ¶chtest, aktiviere stattdessen eine der **Automatischen Aktionen** im untenstehenden Abschnitt.

            âš ï¸ Gib die Namen aller aktivierten **Aktions-Buttons** an, einschlieÃŸlich der LÃ¶schen-SchaltflÃ¤che.
            Fehlt eine Angabe, kÃ¶nnte dies dazu fÃ¼hren, dass die Automation nicht korrekt funktioniert.
          default: []
          selector:
            select:
              options:
                - label: Aktions-Button 1 aktivieren
                  value: "enable_action_button_1"
                - label: Aktions-Button 2 aktivieren
                  value: "enable_action_button_2"
                - label: Aktions-Button 3 aktivieren
                  value: "enable_action_button_3"
              multiple: true
        action_button_1:
          name: Aktions-Button 1
          description: >
            Gib den Namen der SchaltflÃ¤che an, die in der Benachrichtigung angezeigt wird.
            Diese SchaltflÃ¤che lÃ¶st alle Aktionen aus, die unter **Aktion 1** im Abschnitt "Automatische Aktionen" definiert sind.
          default: []
          selector:
            text:
        action_button_2:
          name: Aktions-Button 2
          description: >
            Gib den Namen der SchaltflÃ¤che an, die in der Benachrichtigung angezeigt wird.
            Diese SchaltflÃ¤che lÃ¶st alle Aktionen aus, die unter **Aktion 2** im entsprechenden Abschnitt definiert sind.
          default: []
          selector:
            text:
        action_button_3:
          name: Aktions-Button 3
          description: >
            Gib den Namen der SchaltflÃ¤che an, die in der Benachrichtigung angezeigt wird.
            Diese SchaltflÃ¤che lÃ¶st alle Aktionen aus, die unter **Aktion 3** im entsprechenden Abschnitt definiert sind.
          default: []
          selector:
            text:
        action_button_delete:
          name: LÃ¶schen-SchaltflÃ¤che
          description: >
            Gib den Namen der LÃ¶schen-SchaltflÃ¤che an, die in der Benachrichtigung angezeigt wird.
            Diese SchaltflÃ¤che lÃ¶scht alle Benachrichtigungen, die mit dem angegebenen **Benachrichtigungskanal** verbunden sind.
            Sie wird automatisch zur Benachrichtigung hinzugefÃ¼gt, falls ein Aktions-Button aktiviert wurde.
          default: LÃ¶schen
          selector:
            text:
    auto_action_settings:
      name: "Automatische Aktionen"
      icon: mdi:code-tags
      collapsed: true
      input:
        action_1:
          name: Aktion 1
          description: >
            Gib die Aktionen ein, die ausgefÃ¼hrt werden sollen, wenn die EntitÃ¤t den definierten Zustand erreicht.
            Diese Aktionen sind ebenso mit der **Aktions-Button 1** verknÃ¼pft.
          default: []
          selector:
            action:
        action_2:
          name: Aktion 2
          description: >
            Gib die Aktionen ein, die ausgefÃ¼hrt werden sollen, wenn die EntitÃ¤t den definierten Zustand erreicht.
            Diese Aktionen sind ebenso mit der **Aktions-Button 2** verknÃ¼pft.
          default: []
          selector:
            action:
        action_3:
          name: Aktion 3
          description: >
            Gib die Aktionen ein, die ausgefÃ¼hrt werden sollen, wenn die EntitÃ¤t den definierten Zustand erreicht.
            Diese Aktionen sind ebenso mit der **Aktions-Button 3** verknÃ¼pft.
          default: []
          selector:
            action:
    custom_actions_settings:
      name: "Benutzerdefinierte Aktionen"
      icon: mdi:code-tags
      collapsed: true
      input:
        include_custom_actions:
          name: Benutzerdefinierte Aktionsoption (Optional)
          description: >
            Passe deine Automation mit beliebigen Aktionen an.
            Zum Beispiel kÃ¶nnen spezielle Durchsagen Ã¼ber ausgewÃ¤hlte Lautsprecher ausgefÃ¼hrt werden.
          default: disable_custom_actions
          selector:
            select:
              options:
                - label: Benutzerdefinierte Aktionen aktivieren
                  value: "enable_custom_actions"
                - label: Benutzerdefinierte Aktionen deaktivieren
                  value: "disable_custom_actions"
        custom_actions:
          name: Benutzerdefinierte Aktionen
          description: >
            Gib die benutzerdefinierten Aktionen ein, die ausgefÃ¼hrt werden sollen.
          default: []
          selector:
            action:
    conditions_settings:
      name: "Bedingungen"
      icon: mdi:earth
      collapsed: true
      input:
        global_conditions:
          name: Globale Bedingungen
          description: >
            Gib globale Bedingungen ein, die erfÃ¼llt sein mÃ¼ssen, damit die Automation ausgefÃ¼hrt wird.
          default: []
          selector:
            condition:
        trigger_conditions:
          name: Bedingungen fÃ¼r Trigger-AuslÃ¶ser
          description: >
            Gib Bedingungen ein, die beim AuslÃ¶sen der Trigger zusÃ¤tzlich erfÃ¼llt sein mÃ¼ssen.
          default: []
          selector:
            condition:
        clear_conditions:
          name: Bedingungen fÃ¼r Endzustand
          description: >
            Gib Bedingungen ein, die beim Eintreten des Endzustands zusÃ¤tzlich erfÃ¼llt sein mÃ¼ssen.
          default: []
          selector:
            condition:

mode: restart

variables:
  notify_title: !input notify_title
  notify_message: !input notify_message
  notify_data: !input notify_data
  notify_tag: !input notify_tag
  send_to_car: !input send_to_car
  send_to_work: !input send_to_work
  include_action_buttons: !input include_action_buttons
  action_button_1: !input action_button_1
  action_button_2: !input action_button_2
  action_button_3: !input action_button_3
  action_button_delete: !input action_button_delete
  action_1: !input action_1
  action_2: !input action_2
  action_3: !input action_3
  include_custom_actions: !input include_custom_actions
  custom_actions: !input custom_actions
  global_conditions: !input global_conditions
  trigger_conditions: !input trigger_conditions
  clear_conditions: !input clear_conditions

  notify_devices: >-
    {% set devices = [
      '30d663ef8b06c87a5bdb80a56af74b15',
      '0cfbf22f9dc76ecf11f78017669b1d51'
    ] %}
    {% if send_to_work %}
      {{ devices + [
      'e0f19df8be795d8d5867ccf822025697',
      '170f72bbcf6e90b79e776d8511fc2419'
      ] }}
    {% else %}
      {{ devices }}
    {% endif %}
    {#
    {% if send_to_car %}
      {{ devices + ['7b4588bc469f471e30087c5757f2ebf4'] }}
    {% else %}
      {{ devices }}
    {% endif %}
    #}

  device_message_data: >-
    {% set message = namespace(data={}) %}
    {% set actions = [] %}
    {% if 'high_priority' in notify_data %}
      {% set message.data = dict(message.data, **{ 'ttl': 0, 'priority': 'high' }) %}
    {% endif %}
    {% set message.data = dict(message.data, **{ 'channel': notify_tag }) %}
    {% set message.data = dict(message.data, **{ 'tag': notify_tag }) %}
    {% if 'enable_action_button_1' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_1', 'title': action_button_1 }] %}
    {% endif %}
    {% if 'enable_action_button_2' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_2', 'title': action_button_2 }] %}
    {% endif %}
    {% if 'enable_action_button_3' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_3', 'title': action_button_3 }] %}
    {% endif %}
    {% if 'sticky' in notify_data %}
      {% set message.data = dict(message.data, **{ 'sticky': "true" }) %}
      {% set actions = actions + [{ 'action': 'dismiss', 'title': action_button_delete }] %}
    {% endif %}
    {% if actions | length > 0 %}
      {% set message.data = dict(message.data, **{ 'actions': actions }) %}
    {% endif %}
    {{ message.data }}

triggers:
  # Faltet alle EintrÃ¤ge aus dynamic_trigger an den Anfang deiner Triggerliste
  - triggers: !input dynamic_trigger

  # Feste Buttonâ€‘Events
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: action_button_1
      tag: !input notify_tag
    id: action_button_1

  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: action_button_2
      tag: !input notify_tag
    id: action_button_2

  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: action_button_3
      tag: !input notify_tag
    id: action_button_3

  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: dismiss
      tag: !input notify_tag
    id: clear_notification_button

  # Faltet alle EintrÃ¤ge aus clear_trigger ans Ende der Liste
  - triggers: !input clear_trigger

condition: !input global_conditions

action:
  - choose:
      - alias: "PrÃ¼fe, ob Aktions-Button 1 gedrÃ¼ckt wurde"
        conditions:
          - condition: trigger
            id: action_button_1
        sequence: !input action_1
      - alias: "PrÃ¼fe, ob Aktions-Button 2 gedrÃ¼ckt wurde"
        conditions:
          - condition: trigger
            id: action_button_2
        sequence: !input action_2
      - alias: "PrÃ¼fe, ob Aktions-Button 3 gedrÃ¼ckt wurde"
        conditions:
          - condition: trigger
            id: action_button_3
        sequence: !input action_3
      - alias: "PrÃ¼fe, ob LÃ¶schen-SchaltflÃ¤che gedrÃ¼ckt oder Endzustand erreicht wurde (LÃ¶sch-Trigger)"
        conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: clear_notification_button
              - condition: trigger
                id: clear_notification_trigger
        sequence:
          - choose:
              - conditions: !input clear_conditions
                sequence:
                  - action: script.notification_delete
                    data:
                      notify_tag: "{{ notify_tag }}"
            default:
              - action: script.notification_delete
                data:
                  notify_tag: "{{ notify_tag }}"
      - alias: "PrÃ¼fe Trigger-Bedingungen fÃ¼r Hauptbenachrichtigung"
        conditions:
          - condition: template
            value_template: "{{ not trigger or trigger.get('id') == None }}"
            enabled: false
        sequence:
          - choose:
              - conditions: !input trigger_conditions
                sequence:
                  - alias: "Erstelle persistente Benachrichtigung"
                    service: persistent_notification.create
                    data:
                      title: !input notify_title
                      message: !input notify_message
                      notification_id: !input notify_tag
                  - alias: "Sende eine Benachrichtigung an jedes GerÃ¤t"
                    repeat:
                      for_each: "{{ notify_devices }}"
                      sequence:
                        - variables:
                            sensor_entity_id: "sensor.{{ device_attr(repeat.item, 'name') | slugify }}_active_notification_count"
                        - if:
                            - condition: template
                              value_template: >
                                {% set sensor_entity_id = "sensor.{{ device_attr(repeat.item, 'name') | slugify }}_active_notification_count" %}
                                {% set ns = namespace(notification_exists=false) %}

                                {% if states(sensor_entity_id) != 'unknown' %}
                                  {% set attributes = states[sensor_entity_id].attributes.items() %}
                                  {% for key, value in attributes %}
                                    {% if key.startswith('android.title_io.homeassistant.companion.android_') %}
                                      {% set idx = key.split('_')[-1] %}
                                      {% set big_text_key = "android.bigText_io.homeassistant.companion.android_" ~ idx %}
                                      {% if value == notify_title and state_attr(sensor_entity_id, big_text_key) == notify_message %}
                                        {% set ns.notification_exists = true %}
                                      {% endif %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}

                                {{ not ns.notification_exists }}
                          then:
                            - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                              data:
                                title: !input notify_title
                                message: !input notify_message
                                data: "{{ device_message_data }}"
                  - if:
                      - condition: template
                        alias: "FÃ¼hre benutzerdefinierte Aktion aus"
                        value_template: "{{ 'enable_custom_actions' in include_custom_actions }}"
                    then: !input custom_actions
            default: []
