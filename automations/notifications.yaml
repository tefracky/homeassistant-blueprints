blueprint:
  source_url: "https://raw.githubusercontent.com/tefracky/homeassistant-blueprints/blueprints/automations/notifications-and-announcements.yaml"
  name: Benachrichtigungen (Android + Persistent)
  description: >
    # üì¢ Benachrichtigungen

    **Version: 1.0**

    Lege deinen Ausl√∂ser fest und verteile Nachrichten √ºber verschiedene Kan√§le ‚Äì sowohl als mobile Benachrichtigung als auch als persistente Nachricht in der Home Assistant‚ÄëOberfl√§che. Mit dieser Blaupause kannst du Zustandswechsel und numerische Schwellenwerte √ºberwachen und bei Erreichen eines definierten Zustands Benachrichtigungen versenden. Dar√ºber hinaus hast du die M√∂glichkeit, interaktive Optionen mit Aktions-Buttons und Auto-Aktionen zu konfigurieren sowie benutzerdefinierte Aktionen auszuf√ºhren.

    - **Trigger Optionen:**

      - W√§hle den Zustandswechsel einer oder mehrerer Entit√§ten, der die Automatisierung ausl√∂st, aus.
      - Optionen umfassen allgemeine Zust√§nde (z.‚ÄØB. Button oder beliebiger Zustand, AN, AUS, Nicht verf√ºgbar, Unbekannt), standortbezogene Zust√§nde (Zuhause oder Nicht zu Hause) sowie numerische Zust√§nde (√úber, Unter oder √úber & Unter).

    - **Benachrichtigungsoptionen:**

      - Sende Benachrichtigungen an ein oder mehrere Ger√§te (kompatibel mit Apple iOS und Android).
      - Nutze persistente Benachrichtigungen in der Home Assistant‚ÄëBenutzeroberfl√§che.
      - (Optional) Schalte Text-to-Speech‚ÄëDurchsagen frei (auskommentiert).
      - Konfiguriere interaktive Optionen √ºber Aktions-Buttons.
      - F√ºge benutzerdefinierte Aktionen hinzu.

    - **Zeitbasierte Automatisierung:**

      - Lege exakte Start- und Endzeiten sowie die aktiven Wochentage fest. (Diese Optionen sind auskommentiert.)

    - **Globale Bedingungen:**

      - Erg√§nze globale Bedingungen, die erf√ºllt sein m√ºssen, damit die Automatisierung ausgef√ºhrt wird.

    **Danke** an die originalen Skripte!
      - [Notifications and Announcements](https://gist.github.com/Blackshome/180ca4a24af81cd5d843acfc039039bc)
      - [State Notifications and Actions](https://gist.github.com/Blackshome/06f6f28e76299267b813dac48608f549)
      - **Spende f√ºr den originalen Entwickler:** [Hier klicken](https://www.paypal.com/donate/?hosted_button_id=WAZS3QSDTPGA8) üôÇ
      - Brauchst du Hilfe? Sieh dir die FAQ an: [Hier klicken](https://community.home-assistant.io/t/notifications-announcements/728100/2?u=blacky)
      - Unterst√ºtzung f√ºr Notifications and Actions: [Hier klicken](https://community.home-assistant.io/t/notifications-announcements/728100?u=blacky)
  domain: automation
  input:
    trigger_settings:
      name: "Trigger"
      icon: mdi:cog-outline
      collapsed: true
      input:
        trigger_state:
          name: Trigger - Zustand
          description: >
            Bitte w√§hle den Zustand, der den Trigger ausl√∂sen soll.
            Du kannst aus den zehn verf√ºgbaren Optionen im Dropdown-Men√º w√§hlen.
            Falls deine Option nicht vorhanden ist, gib einfach deinen gew√ºnschten Zustand ein und klicke auf Speichern.
            
            1 - Button Oder Beliebiger Zustand
            
            2 - AN
            
            3 - AUS
            
            4 - Nicht verf√ºgbar
            
            5 - Unbekannt
            
            6 - Zuhause
            
            7 - Nicht zu Hause
            
            8 - Numerischer Zustand ‚Äì √úber
            
            9 - Numerischer Zustand ‚Äì Unter
            
            10 - Numerischer Zustand ‚Äì √úber & Unter
            
            Das Nummerierungssystem erleichtert die Navigation und hilft dir, die Einstellungen zu identifizieren.
          default: button_any_state
          selector:
            select:
              custom_value: true
              mode: dropdown
              options:
                - label: "1 - Button Oder Beliebiger Zustand"
                  value: "button_any_state"
                - label: "2 - AN"
                  value: "on"
                - label: "3 - AUS"
                  value: "off"
                - label: "4 - Nicht verf√ºgbar"
                  value: "unavailable"
                - label: "5 - Unbekannt"
                  value: "unknown"
                - label: "6 - Zuhause"
                  value: "home"
                - label: "7 - Nicht zu Hause"
                  value: "not_home"
                - label: "8 - Numerischer Zustand ‚Äì √úber"
                  value: "numeric_state_above"
                - label: "9 - Numerischer Zustand ‚Äì Unter"
                  value: "numeric_state_below"
                - label: "10 - Numerischer Zustand ‚Äì √úber & Unter"
                  value: "numeric_state_above_below"
        trigger_state_entity:
          name: Zustands-Entit√§ten
          description: >
            **Verwendet in den Optionen 1, 2, 3, 4, 5, 6 oder 7.**
            Gib die Entit√§ten an, die den Zustandswechsel ausl√∂sen.
          default: []
          selector:
            entity:
              multiple: true
        trigger_numeric_entity:
          name: Numerische Zustands-Entit√§ten
          description: >
            **Verwendet in den Optionen 8, 9 oder 10.**
            Gib die Entit√§ten an, die den numerischen Zustandswechsel √ºberwachen.
          default: []
          selector:
            entity:
              multiple: true
        above_state:
          name: Numerischer Zustand ‚Äì √úber Option
          description: >
            **Verwendet in den Optionen 8 oder 10.**
            Setze den Schwellenwert, ab dem der numerische Zustand als √ºberschritten gilt.
          default: 0
          selector:
            number:
              min: -20
              max: 100
              step: 1
              unit_of_measurement: Wert
        below_state:
          name: Numerischer Zustand ‚Äì Unter Option
          description: >
            **Verwendet in den Optionen 9 oder 10.**
            Setze den Schwellenwert, unter den der numerische Zustand f√§llt.
          default: 0
          selector:
            number:
              min: -20
              max: 100
              step: 1
              unit_of_measurement: Wert
        time_delay_state:
          name: Zeitverz√∂gerung
          description: >
            **Verwendet in allen Optionen.**
            Bestimme die Dauer, die der Triggerzustand kontinuierlich bestehen muss, bevor die Automatisierung ausgef√ºhrt wird.
          default:
            hours: 0
            minutes: 0
            seconds: 0
          selector:
            duration:
    device_notify_settings:
      name: "Benachrichtigungen (Mobil und Persistent)"
      icon: mdi:devices
      collapsed: true
      input:
        include_notify:
          name: Mobile App Benachrichtigungsoption
          description: >
            Diese Option ist immer aktiviert, um Benachrichtigungen an die ausgew√§hlten Ger√§te zu senden.
          default: enable_mobile_app_notify
          selector:
            select:
              options:
                - label: Mobile App Benachrichtigungsoption aktivieren
                  value: "enable_mobile_app_notify"
                - label: Mobile App Benachrichtigungsoption deaktivieren
                  value: "disable_mobile_app_notify"
        notify_device:
          name: Ger√§te zur Benachrichtigung
          description: >
            W√§hle die Ger√§te aus, die benachrichtigt werden sollen, wenn die Automatisierung ausgel√∂st wird.
          default:
            - 7b4588bc469f471e30087c5757f2ebf4
            - 30d663ef8b06c87a5bdb80a56af74b15
            - e0f19df8be795d8d5867ccf822025697
            - 0cfbf22f9dc76ecf11f78017669b1d51
            - 170f72bbcf6e90b79e776d8511fc2419
          selector:
            device:
              filter:
                - integration: mobile_app
              multiple: true
        notify_title:
          name: Benachrichtigungstitel
          description: >
            Gib den Titel der Benachrichtigung ein, der sowohl f√ºr die Android-Benachrichtigung als auch f√ºr die persistente Benachrichtigung in der UI verwendet wird.
          default: "üì¢ Gebe hier den Benachrichtigungstitel ein"
          selector:
            text:
        notify_message:
          name: Benachrichtigungsnachricht
          description: >
            Gib die Nachricht der Benachrichtigung ein, die sowohl f√ºr die Android-Benachrichtigung als auch f√ºr die persistente Benachrichtigung in der UI verwendet wird.
          default: "Gebe hier die Benachrichtigungsnachricht ein üôÇ"
          selector:
            text:
        notify_data:
          name: "Android-spezifische Optionen (Optional)"
          description: >
            **Optionen f√ºr Android (Optional):**
            - **High Priority**: Benachrichtigungen werden sofort zugestellt, um sicherzustellen, dass wichtige Meldungen umgehend empfangen werden.
            - **Sticky Notification**: Wichtige Meldungen bleiben in der Benachrichtigungsleiste, bis sie aktiv entfernt werden.
            - **Notification Channel**: Organisiert verschiedene Benachrichtigungseinstellungen (T√∂ne, Vibrationen etc.). Diese Option erfordert die Eingabe eines Channel-Namens.
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: Hochpriorit√§t
                  value: "high_priority"
                - label: Sticky Notification
                  value: "sticky"
        notify_channel:
          name: Notification Channel ‚Äì Android & Persistent
          description: >
            Gib den Namen des Notification Channels ein. Dieser Channel wird auch als Tag f√ºr die persistente Benachrichtigung verwendet.
            Diese Eingabe ist stets erforderlich. Falls noch kein Channel existiert, wird dieser beim ersten Senden der Benachrichtigung erstellt.
            Empfohlenes Icon: mdi:radio
          default: "default-channel"
          selector:
            text:
    action_settings:
      name: "Aktions-Buttons"
      icon: mdi:gesture-tap
      collapsed: true
      input:
        include_action_buttons:
          name: "Benachrichtigungs-Aktions-Buttons Optionen (Optional)"
          description: >
            Aktiviere die Aktions-Buttons, die du verwenden m√∂chtest. Diese Tasten werden in der Benachrichtigung angezeigt und erm√∂glichen es dir, durch einen Klick Aktionen auszuf√ºhren.

            **Hinweis** ‚Äì Es ist nicht zwingend erforderlich, Aktions-Buttons auszuw√§hlen, um eine Aktion auszuf√ºhren.
            Falls du eine Aktion automatisiert starten m√∂chtest, ohne einen Aktions-Button zu verwenden, kannst du stattdessen die **Auto Aktion** in der folgenden **Aktionen**-Sektion aktivieren.

            ‚ö†Ô∏è Gib unten die Namen aller aktivierten **Aktions-Buttons** ein, einschlie√ülich des **Abbrechen-Aktions-Buttons**.
            Fehlt ein Buttonname, k√∂nnte dies verhindern, dass die Automatisierung korrekt funktioniert und die Benachrichtigung nicht empfangen wird.
          default: []
          selector:
            select:
              options:
                - label: "Aktions-Button 1 aktivieren"
                  value: "enable_action_button_1"
                - label: "Aktions-Button 2 aktivieren"
                  value: "enable_action_button_2"
                - label: "Aktions-Button 3 aktivieren"
                  value: "enable_action_button_3"
              multiple: true
        action_button_1:
          name: Aktions-Button 1
          description: >
            Gib den Namen des Buttons ein, der in der Benachrichtigung angezeigt wird.
            Dieser Button f√ºhrt alle Aktionen aus, die im Feld **Aktion 1** in der folgenden **Aktionen**-Sektion definiert sind.
          default: []
          selector:
            text:
        action_button_2:
          name: Aktions-Button 2
          description: >
            Gib den Namen des Buttons ein, der in der Benachrichtigung angezeigt wird.
            Dieser Button f√ºhrt alle Aktionen aus, die im Feld **Aktion 2** in der folgenden **Aktionen**-Sektion definiert sind.
          default: []
          selector:
            text:
        action_button_3:
          name: Aktions-Button 3
          description: >
            Gib den Namen des Buttons ein, der in der Benachrichtigung angezeigt wird.
            Dieser Button f√ºhrt alle Aktionen aus, die im Feld **Aktion 3** in der folgenden **Aktionen**-Sektion definiert sind.
          default: []
          selector:
            text:
        action_button_stop:
          name: Abbrechen-Aktions-Button
          description: >
            Gib den Namen des Abbrechen-Buttons ein, der in der Benachrichtigung angezeigt wird.
            Dieser Button bricht alle Aktionen ab und stoppt die Automatisierung.
            Er wird automatisch in die Benachrichtigung aufgenommen, sofern ein Aktions-Button aktiviert wurde.
          default: Cancel
          selector:
            text:
    auto_action_settings:
      name: "Aktionen"
      icon: mdi:code-tags
      collapsed: true
      input:
        include_auto_actions:
          name: "Auto-Aktionsoptionen verwenden (Optional)"
          description: >
            Wenn die Auto-Aktionsoption aktiviert ist, werden die unten definierten **Aktionen** automatisch ausgef√ºhrt, sobald die Entit√§t den festgelegten Zustand erreicht.
            
            Wenn du Aktions-Buttons in der Benachrichtigung verwendest, ist es nicht zwingend erforderlich, die Auto-Aktion zu aktivieren, da das Dr√ºcken eines Aktions-Buttons die zugeordnete Aktion ausl√∂st.
            Solltest du jedoch die Benachrichtigung verpassen, sorgt die Auto-Aktionsoption daf√ºr, dass die Aktionen nach Ablauf der festgelegten Verz√∂gerung trotzdem ausgef√ºhrt werden.
          default: []
          selector:
            select:
              options:
                - label: "Auto Aktion 1 aktivieren"
                  value: "enable_action_1"
                - label: "Auto Aktion 2 aktivieren"
                  value: "enable_action_2"
                - label: "Auto Aktion 3 aktivieren"
                  value: "enable_action_3"
              multiple: true
        action_1:
          name: Aktion 1
          description: >
            Gib die Aktionen ein, die ausgef√ºhrt werden sollen, wenn sich die Entit√§t √§ndert.
            Diese Aktionen sind mit dem **Aktions-Button 1** in der obigen **Aktions-Buttons**-Sektion verkn√ºpft.
          default: []
          selector:
            action:
        action_2:
          name: Aktion 2
          description: >
            Gib die Aktionen ein, die ausgef√ºhrt werden sollen, wenn sich die Entit√§t √§ndert.
            Diese Aktionen sind mit dem **Aktions-Button 2** in der obigen **Aktions-Buttons**-Sektion verkn√ºpft.
          default: []
          selector:
            action:
        action_3:
          name: Aktion 3
          description: >
            Gib die Aktionen ein, die ausgef√ºhrt werden sollen, wenn sich die Entit√§t √§ndert.
            Diese Aktionen sind mit dem **Aktions-Button 3** in der obigen **Aktions-Buttons**-Sektion verkn√ºpft.
          default: []
          selector:
            action:
    custom_actions_settings:
      name: "Benutzerdefinierte Aktionen"
      icon: mdi:code-tags
      collapsed: true
      input:
        include_custom_actions:
          name: Benutzerdefinierte Aktionsoption (Optional)
          description: >
            Passe deine Automatisierung mit beliebigen Aktionen an.
            Zum Beispiel kannst du Durchsagen √ºber spezielle Lautsprecher ausf√ºhren.
          default: disable_custom_actions
          selector:
            select:
              options:
                - label: Benutzerdefinierte Aktionen aktivieren
                  value: "enable_custom_actions"
                - label: Benutzerdefinierte Aktionen deaktivieren
                  value: "disable_custom_actions"
        custom_actions:
          name: Benutzerdefinierte Aktionen
          description: >
            Gib die benutzerdefinierten Aktionen ein, die ausgef√ºhrt werden sollen.
          default: []
          selector:
            action:
    global_conditions_settings:
      name: "Globale Bedingungen"
      icon: mdi:earth
      collapsed: true
      input:
        global_conditions:
          name: Globale Bedingungen
          description: >
            Gib globale Bedingungen ein, die erf√ºllt sein m√ºssen, damit die Automatisierung ausgef√ºhrt wird.
          default: []
          selector:
            condition:
mode: single
max_exceeded: silent

variables:
  trigger_state: !input trigger_state
  trigger_state_entity: !input trigger_state_entity
  trigger_numeric_entity: !input trigger_numeric_entity
  above_state: !input above_state
  below_state: !input below_state
  time_delay_state: !input time_delay_state
  include_notify: !input include_notify
  notify_device: !input notify_device
  notify_title: !input notify_title
  notify_message: !input notify_message
  notify_data: !input notify_data
  notify_channel: !input notify_channel
  include_action_buttons: !input include_action_buttons
  action_button_1: !input action_button_1
  action_button_2: !input action_button_2
  action_button_3: !input action_button_3
  action_button_stop: !input action_button_stop
  include_auto_actions: !input include_auto_actions
  action_1: !input action_1
  action_2: !input action_2
  action_3: !input action_3
  include_custom_actions: !input include_custom_actions
  custom_actions: !input custom_actions
  global_conditions: !input global_conditions

  device_message_data: >-
    {% set message = namespace(data={}) %}
    {% set push = namespace(data={}) %}
    {% set actions = [] %}
    {# iOS-spezifische Optionen auskommentiert #}
    {# if notify_interruption_level in ['active', 'critical', 'time-sensitive', 'passive'] #}
      {# set push.data = dict(push.data, **{ 'interruption-level': notify_interruption_level }) #}
    {# endif #}
    {# if notify_sound != [] #}
      {# set push.data = dict(push.data, **{ 'sound': notify_sound }) #}
    {# endif #}
    {% if push.data %}
      {% set message.data = dict(message.data, **{ 'push': push.data }) %}
    {% endif %}
    {% if 'high_priority' in notify_data %}
      {% set message.data = dict(message.data, **{ 'ttl': 0, 'priority': 'high' }) %}
    {% endif %}
    {% set message.data = dict(message.data, **{ 'channel': notify_channel }) %}
    {% set message.data = dict(message.data, **{ 'tag': notify_channel }) %}
    {% if 'enable_action_button_1' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_1', 'title': action_button_1 }] %}
    {% endif %}
    {% if 'enable_action_button_2' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_2', 'title': action_button_2 }] %}
    {% endif %}
    {% if 'enable_action_button_3' in include_action_buttons %}
      {% set actions = actions + [{ 'action': 'action_button_3', 'title': action_button_3 }] %}
    {% endif %}
    {% if 'sticky' in notify_data %}
      {% set message.data = dict(message.data, **{ 'sticky': "true" }) %}
      {% set actions = actions + [{'action': 'dismiss', 'title': 'L√∂schen'}] %}
    {% endif %}
    {% if actions | length > 0 %}
      {% set message.data = dict(message.data, **{ 'actions': actions }) %}
    {% endif %}
    {{ message.data }}

  filtered_devices: "{{ notify_device }}"

triggers:
  - trigger: state
    id: "t0"
    entity_id: !input trigger_state_entity
    for: !input time_delay_state
  - trigger: state
    id: "t1"
    entity_id: !input trigger_state_entity
    to: !input trigger_state
    for: !input time_delay_state
  - trigger: numeric_state
    id: "t2"
    entity_id: !input trigger_numeric_entity
    above: !input above_state
    for: !input time_delay_state
  - trigger: numeric_state
    id: "t3"
    entity_id: !input trigger_numeric_entity
    below: !input below_state
    for: !input time_delay_state
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "action_button_1"
      tag: !input notify_channel
    id: action_button_1
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "action_button_2"
      tag: !input notify_channel
    id: action_button_2
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "action_button_3"
      tag: !input notify_channel
    id: action_button_3
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: "dismiss"
      tag: !input notify_channel
    id: clear_notification_trigger

condition:
  - condition: or
    conditions:
      - condition: and
        conditions:
          - condition: trigger
            id: 't0'
          - "{{ trigger_state == 'button_any_state' }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't1'
          - "{{ (trigger_state != 'button_any_state') or (trigger_state != 'numeric_state_above') or (trigger_state != 'numeric_state_below') or (trigger_state != 'numeric_state_above_below') }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't2'
          - "{{ (trigger_state == 'numeric_state_above') or (trigger_state == 'numeric_state_above_below') }}"
      - condition: and
        conditions:
          - condition: trigger
            id: 't3'
          - "{{ (trigger_state == 'numeric_state_below') or (trigger_state == 'numeric_state_above_below') }}"
      - condition: trigger
        id: action_button_1
      - condition: trigger
        id: action_button_2
      - condition: trigger
        id: action_button_3
      - condition: trigger
        id: clear_notification_trigger
  - condition: and
    conditions: !input global_conditions

action:
  - choose:
    - alias: "Pr√ºfe, ob Aktions-Button 1 gedr√ºckt wurde"
      conditions:
        - condition: trigger
          id: action_button_1
      sequence: !input action_1
    - alias: "Pr√ºfe, ob Aktions-Button 2 gedr√ºckt wurde"
      conditions:
        - condition: trigger
          id: action_button_2
      sequence: !input action_2
    - alias: "Pr√ºfe, ob Aktions-Button 3 gedr√ºckt wurde"
      conditions:
        - condition: trigger
          id: action_button_3
      sequence: !input action_3
    - alias: "Pr√ºfe, ob der Abbrechen-Button gedr√ºckt wurde"
      conditions:
        - condition: trigger
          id: clear_notification_trigger
      sequence:
        - repeat:
            for_each: "{{ filtered_devices }}"
            sequence:
              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                data:
                  message: "clear_notification"
                  data:
                    tag: !input notify_channel
    default:
      - alias: "Sende eine Benachrichtigung an jedes Ger√§t"
        repeat:
          for_each: "{{ filtered_devices }}"
          sequence:
            - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
              data:
                title: !input notify_title
                message: !input notify_message
                data: "{{ device_message_data }}"
      - alias: "Erstelle persistente Benachrichtigung"
        service: persistent_notification.create
        data:
          title: !input notify_title
          message: !input notify_message
          notification_id: !input notify_channel
      - if:
          - condition: template
            alias: "F√ºhre benutzerdefinierte Aktion aus"
            value_template: "{{ 'enable_custom_actions' in include_custom_actions }}"
        then: !input custom_actions
